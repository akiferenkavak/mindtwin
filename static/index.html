<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MindTwin Live Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 2rem;
    }
    h1 { margin-bottom: 1rem; }
    #info { font-size: 1.2rem; margin-bottom: 1rem; }
    #thermo {
      width: 300px;
      height: 20px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    #bar {
      height: 100%;
      width: 0%;
      background: blue;
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>
  <h1>MindTwin Live Monitor</h1>
  <div id="info">Connecting...</div>
  <div id="thermo"><div id="bar"></div></div>
  <canvas id="chart" width="600" height="300"></canvas>

  <h2>Anomalies</h2>
  <div id="alerts" style="max-height: 200px; overflow-y: auto;"></div>

  <script>
  const info = document.getElementById("info");
  const bar = document.getElementById("bar");
  const alerts = document.getElementById("alerts");
  const ctx = document.getElementById("chart").getContext("2d");

  const chart = new Chart(ctx, {
      type: 'line',
      data: {
          datasets: [{
              label: 'Max °C',
              data: [],
              borderColor: 'white',
              backgroundColor: 'rgba(255,255,255,0.05)',
              tension: 0.2,
              pointRadius: 5,
              pointBackgroundColor: []
          }]
      },
      options: {
          animation: false,
          responsive: true,
          scales: {
              x: {
                  type: 'linear',
                  title: { display: true, text: 'Frame #' },
                  min: 0,
                  max: 100
              },
              y: {
                  title: { display: true, text: 'Temperature (°C)' },
                  suggestedMin: 0,
                  suggestedMax: 100
              }
          },
          plugins: {
              legend: { labels: { color: '#ccc' } }
          }
      }
  });

  // === CREATE WEBSOCKET ===
  const ws = new WebSocket("ws://localhost:8000/ws");

  ws.onmessage = (event) => {
      const frame = JSON.parse(event.data);
      const temp = frame.t_max;
      const color = temp < 22 ? "blue" : temp < 28 ? "green" : temp < 30 ? "yellow" : temp < 31 ? "orange" : "red";

      bar.style.background = color;
      bar.style.width = Math.min(temp, 100) + "%";
      info.innerText = `Frame #${frame.frame_no} | Max: ${temp.toFixed(2)} °C`;

      // push new point
      chart.data.datasets[0].data.push({x: frame.frame_no, y: temp});
      chart.data.datasets[0].pointBackgroundColor.push(color);

      // sliding window: show only last 150 frames
      const slideWindow = 100;

      // push new point
      chart.data.datasets[0].data.push({x: frame.frame_no, y: temp});
      chart.data.datasets[0].pointBackgroundColor.push(color);

      if (chart.data.datasets[0].data.length > slideWindow) {
          // remove oldest point
          chart.data.datasets[0].data.shift();
          chart.data.datasets[0].pointBackgroundColor.shift();
          // slide axis to last `slideWindow` points
          const firstFrame = chart.data.datasets[0].data[0].x;
          chart.options.scales.x.min = firstFrame;
          chart.options.scales.x.max = firstFrame + slideWindow - 1;
      } else {
          // for first 150 points, fix x-axis min=0, max=150
          chart.options.scales.x.min = 0;
          chart.options.scales.x.max = slideWindow - 1;
      }

      chart.update('none');


      // show anomalies
      if (temp >= 30) {
          const p = document.createElement("p");
          p.innerText = `⚠️ ${frame.timestamp} | ${temp.toFixed(2)}°C HIGH`;
          p.style.color = "red";
          alerts.appendChild(p);
          alerts.scrollTop = alerts.scrollHeight;
      }
  };

  ws.onclose = () => {
      info.innerText = "Connection closed";
  };
  </script>

</body>

</html>
